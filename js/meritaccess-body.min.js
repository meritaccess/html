$(document).ready(function() {
	var currentPage = 0;
	var table = $('#data-table').DataTable({
		"dom": '<"#data-table-header"f>r<"#data-table-scroll"t><"#data-table-footer"lip>',
		"processing": true,
		"language": {
			"processing": 'Loading...',
			"search": 'Filter',
			"paginate": {
				"first": '&laquo;',
				"previous": '&lsaquo;',
				"next": '&rsaquo;',
				"last": '&raquo;'
			}
		},
		"order": [],
		"pageLength": 50,
		"pagingType": 'full',
		"fnDrawCallback": function(oSettings) {
			var totalPages = this.api().page.info().pages;
			if (totalPages == 1) {
				$('.dt-length').addClass('hidden-area');
				$('.dt-paging').addClass('hidden-area');
			} else {
				$('.dt-length').removeClass('hidden-area');
				$('.dt-paging').removeClass('hidden-area');
			}
		}
	});
	$.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
		return !$(table.row(dataIndex).node()).hasClass('tr-deleted');
	});
	var toggleButton = $('<button type="button">Show blocked</button>').insertAfter('#dt-search-0').on('click', function() {
		var showDeleted = $(this).hasClass('active');
		if (showDeleted) {
			$(this).removeClass('active').text('Hide blocked');
		} else {
			$(this).addClass('active').text('Show blocked');
		}
		currentPage = table.page();
		$.fn.dataTable.ext.search.pop();
		if (!showDeleted) {
			$.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
				return !$(table.row(dataIndex).node()).hasClass('tr-deleted');
			});
		}
		table.draw();
	});
	toggleButton.trigger('click');
	table.on('init.dt', function() {
		var state = table.state.loaded();
		if (state) {
			table.page(state.start / state.length).draw(false);
		}
	});
	$('#copy-data').click(function() {
		var start1 = $('#tempstart1').val();
		var end1 = $('#tempend1').val();
		var start2 = $('#tempstart2').val();
		var end2 = $('#tempend2').val();
		$('input[id$="start1"]').val(start1);
		$('input[id$="end1"]').val(end1);
		$('input[id$="start2"]').val(start2);
		$('input[id$="end2"]').val(end2);
	});
	initTimeHHMMSS();
	$("#infobtn").fancybox({
		'width': 800,
		'height': 'auto',
		'maxWidth': 800,
		'maxHeight': 600,
		'autoSize': false,
		'fitToView': false,
		'titlePosition': 'inside',
		'transitionIn': 'none',
		'transitionOut': 'none',
		'onStart': null,
		'onClosed': null,
		preventScroll: true,
		touch: false
	});
	function fetchServerTime() {
		$.ajax({
			type: 'POST',
			url: '',
			data: { action: 'get_time' },
			success: function(data) {
				$('#datetime').text(data);
			},
			error: function() {
				console.error('Failed to get date and time from server.');
			}
		});
	}
	setInterval(fetchServerTime, 1000);
	fetchServerTime();
	$('.table-container-scroll').hide();
	$('.data-table-cap').click(function() {
		$(this).next('.table-container-scroll').fadeToggle();
		var icon = $(this).find('span');
		if (icon.hasClass('cap-plus')) {
			icon.removeClass('cap-plus').addClass('cap-minus');
		} else {
			icon.removeClass('cap-minus').addClass('cap-plus');
		}
	});
});
function initTimeHHMMSS() {
	$(".time-hhmmss").attr('maxlength', '8');
	$(".time-hhmmss").on({
		keydown: CheckNum,
		blur: formateHHMMSS,
		focus: unformateHHMMSS
	});
}
function CheckNum(e) {
	if ($.inArray(e.keyCode, [46, 8, 9, 27, 13]) !== -1 || (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) || (e.keyCode >= 35 && e.keyCode <= 40)) {
		return;
	}
	if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105)) {
		e.preventDefault();
	}
}
function unformateHHMMSS() {
	$(this).val($(this).val().replace(/:/g, ''));
}
function formateHHMMSS() {
	var str = $(this).val();
	if (str.length > 4) {
		str = ('0' + str).slice(-6);
	} else if (str.length > 2) {
		str = ('0' + str + '00').slice(-6);
	} else {
		str = ('0' + str + '0000').slice(-6);
	}
	var ss = parseInt(str.substr(4, 2));
	var mm = parseInt(str.substr(2, 2));
	var hh = parseInt(str.slice(0, 2));
	if (ss > 59) {
		ss = 59;
	}
	if (mm > 59) {
		mm = 59;
	}
	if (hh > 23) {
		hh = 23;
	}
	ss = ('0' + ss).slice(-2);
	mm = ('0' + mm).slice(-2);
	hh = ('0' + hh).slice(-2);
	var formate = hh + ':' + mm + ':' + ss;
	$(this).val(formate);
}